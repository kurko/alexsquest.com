#!/usr/bin/env bash

DEPLOY_BRANCH=gh-pages
# Jekyll will not allow custom ENV variables like JEKYLL_ENV when in the
# gh-pages branch, so I need to go to another branch, build it, then merge
# it into gh-pages.

# echo "> git checkout $INTERMEDIARY_BRANCH"
# git checkout $INTERMEDIARY_BRANCH 2>/dev/null || git checkout -b $INTERMEDIARY_BRANCH
# if [[ $? != 0 ]]; then echo "Cannot checkout $INTERMEDIARY_BRANCH"; exit 1; fi

echo "> git checkout $DEPLOY_BRANCH"
git checkout $DEPLOY_BRANCH
if [[ $? != 0 ]]; then echo "Cannot checkout $DEPLOY_BRANCH"; exit 1; fi

echo "> git merge master --no-edit"
git merge master --no-edit
if [[ $? != 0 ]]; then echo "Cannot merge cleanly. Please fix conflicts and try again."; exit $?; fi

echo "> rm -rf _site ./*.html"
rm -rf _site ./*.html
echo "> JEKYLL_ENV=production bundle exec jekyll build"
JEKYLL_ENV=production bundle exec jekyll build
if [[ $? != 0 ]]; then echo "Cannot build."; exit $?; fi

echo "> rsync -a -I _site/ ./"
rsync -a -I _site/ ./
if [[ $? != 0 ]]; then echo "Cannot rsync."; exit $?; fi

echo "> git add . && git add . -u"
git add . && git add . -u
if [[ $? != 0 ]]; then echo "Cannot add files to stage."; exit $?; fi

echo "> git commit -m \"Deploy\""
git commit -m "Deploy"

echo "> git push origin $DEPLOY_BRANCH --force"
git push origin $DEPLOY_BRANCH --force
if [[ $? != 0 ]]; then echo "Cannot push to Github."; exit $?; fi

echo "> git checkout master"
git checkout master
if [[ $? != 0 ]]; then echo "Cannot checkout master."; exit $?; fi

echo "Deployed to http://alexsquest.com"
